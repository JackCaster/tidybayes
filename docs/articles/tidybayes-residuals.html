<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Extracting and visualizing tidy residuals from Bayesian models • tidybayes</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/paper/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Extracting and visualizing tidy residuals from Bayesian models">
<meta property="og:description" content="">
<meta property="og:image" content="http://mjskay.github.io/tidybayes/logo.png">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-93322-5"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-93322-5');
</script>
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">tidybayes</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.0.3.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/tidybayes.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/tidy-brms.html">Extracting and visualizing tidy draws from brms models</a>
    </li>
    <li>
      <a href="../articles/tidy-rstanarm.html">Extracting and visualizing tidy draws from rstanarm models</a>
    </li>
    <li>
      <a href="../articles/tidybayes-residuals.html">Extracting and visualizing tidy residuals from Bayesian models</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mjskay/tidybayes">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Extracting and visualizing tidy residuals from Bayesian models</h1>
                        <h4 class="author">Matthew Kay</h4>
            
            <h4 class="date">2019-01-04</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/mjskay/tidybayes/blob/master/vignettes/tidybayes-residuals.Rmd"><code>vignettes/tidybayes-residuals.Rmd</code></a></small>
      <div class="hidden name"><code>tidybayes-residuals.Rmd</code></div>

    </div>

    
    
<style type="text/css">
.kable-table table {
  margin-left: 0;
}
img {
  border: none;
}
</style>
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p>This vignette describes how to use the <code>tidybayes</code> package to extract <a href="http://dx.doi.org/10.18637/jss.v059.i10">tidy</a> data frames of draws from draws from resiudals from Bayesian models, and also acts as a demo for the construction of randomized quantile residuals, a generic form of residual applicable to a wide range of models, including censored regressions and models with discrete response variables. For a more general introduction to <code>tidybayes</code>, see <code><a href="tidybayes.html">vignette(“tidybayes”)</a></code>.</p>
</div>
<div id="setup" class="section level2">
<h2 class="hasAnchor">
<a href="#setup" class="anchor"></a>Setup</h2>
<p>The following libraries are required to run this vignette:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(dplyr)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(purrr)</a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(tidyr)</a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(tidybayes)</a>
<a class="sourceLine" id="cb1-5" data-line-number="5"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(ggplot2)</a>
<a class="sourceLine" id="cb1-6" data-line-number="6"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(ggridges)</a>
<a class="sourceLine" id="cb1-7" data-line-number="7"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(cowplot)</a>
<a class="sourceLine" id="cb1-8" data-line-number="8"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(rstan)</a>
<a class="sourceLine" id="cb1-9" data-line-number="9"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(brms)</a>
<a class="sourceLine" id="cb1-10" data-line-number="10"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(gganimate)</a>
<a class="sourceLine" id="cb1-11" data-line-number="11"></a>
<a class="sourceLine" id="cb1-12" data-line-number="12"><span class="kw">theme_set</span>(<span class="kw"><a href="../reference/theme_tidybayes.html">theme_tidybayes</a></span>() <span class="op">+</span><span class="st"> </span><span class="kw">panel_border</span>() <span class="op">+</span><span class="st"> </span><span class="kw">background_grid</span>())</a></code></pre></div>
<p>These options help Stan run faster:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw">rstan_options</span>(<span class="dt">auto_write =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/options">options</a></span>(<span class="dt">mc.cores =</span> parallel<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/parallel/topics/detectCores">detectCores</a></span>())</a></code></pre></div>
</div>
<div id="example-dataset" class="section level2">
<h2 class="hasAnchor">
<a href="#example-dataset" class="anchor"></a>Example dataset</h2>
<p>We’re going to use a simple dataset to demonstrate residuals that can be applied to discrete and censored outcomes. We’ll generate data from a Normal distribution:</p>
<p><span class="math display">\[
\begin{align*}
y^* &amp;\sim \textrm{Normal}(0.5,1) \\
y_\textrm{lower} &amp;= \lfloor{y^*}\rfloor \\
y_\textrm{upper} &amp;= \lceil{y^*}\rceil
\end{align*}
\]</span> We don’t observe <span class="math inline">\(y^*\)</span>, only <span class="math inline">\(y_\textrm{lower}\)</span> and <span class="math inline">\(y_\textrm{upper}\)</span>, i.e., the upper and lower bounds of an interval in which <span class="math inline">\(y^*\)</span> lies. This is <em>interval-censored</em> data.</p>
<p>We can generate it as follows:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Random">set.seed</a></span>(<span class="dv">4118</span>)</a>
<a class="sourceLine" id="cb3-2" data-line-number="2">n =<span class="st"> </span><span class="dv">100</span></a>
<a class="sourceLine" id="cb3-3" data-line-number="3"></a>
<a class="sourceLine" id="cb3-4" data-line-number="4">cens_df =</a>
<a class="sourceLine" id="cb3-5" data-line-number="5"><span class="st">  </span><span class="kw">data_frame</span>(</a>
<a class="sourceLine" id="cb3-6" data-line-number="6">    <span class="dt">y_star =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">rnorm</a></span>(n, <span class="fl">0.5</span>, <span class="dv">1</span>),</a>
<a class="sourceLine" id="cb3-7" data-line-number="7">    <span class="dt">y_lower =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Round">floor</a></span>(y_star),</a>
<a class="sourceLine" id="cb3-8" data-line-number="8">    <span class="dt">y_upper =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Round">ceiling</a></span>(y_star),</a>
<a class="sourceLine" id="cb3-9" data-line-number="9">    <span class="dt">censoring =</span> <span class="st">"interval"</span></a>
<a class="sourceLine" id="cb3-10" data-line-number="10">  )</a></code></pre></div>
<p>A snapshot of the data looks like this:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/head">head</a></span>(cens_df, <span class="dv">10</span>)</a></code></pre></div>
<pre><code>## # A tibble: 10 x 4
##     y_star y_lower y_upper censoring
##      &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;chr&gt;    
##  1  0.180        0       1 interval 
##  2  1.05         1       2 interval 
##  3  2.05         2       3 interval 
##  4 -0.512       -1       0 interval 
##  5  0.0323       0       1 interval 
##  6  1.18         1       2 interval 
##  7 -0.707       -1       0 interval 
##  8  0.116        0       1 interval 
##  9  0.183        0       1 interval 
## 10  0.385        0       1 interval</code></pre>
<p>This is a typical tidy format data frame: one observation per row.</p>
<p>A graphical depiction of the censoring process might be something like this:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1">uncensored_plot =<span class="st"> </span>cens_df <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">y =</span> <span class="st">""</span>, <span class="dt">x =</span> y_star)) <span class="op">+</span></a>
<a class="sourceLine" id="cb6-3" data-line-number="3"><span class="st">  </span><span class="kw">geom_density_ridges</span>(<span class="dt">bandwidth =</span> <span class="fl">0.5</span>, <span class="dt">scale =</span> <span class="fl">1.5</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb6-4" data-line-number="4"><span class="st">  </span><span class="kw">geom_jitter</span>(<span class="kw">aes</span>(<span class="dt">y =</span> <span class="fl">0.75</span>, <span class="dt">color =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/factor">ordered</a></span>(y_lower)), <span class="dt">position =</span> <span class="kw">position_jitter</span>(<span class="dt">height =</span> <span class="fl">0.2</span>), <span class="dt">show.legend =</span> <span class="ot">FALSE</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb6-5" data-line-number="5"><span class="st">  </span><span class="kw">ylab</span>(<span class="ot">NULL</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb6-6" data-line-number="6"><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="dt">breaks =</span> <span class="dv">-4</span><span class="op">:</span><span class="dv">4</span>, <span class="dt">limits =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="op">-</span><span class="dv">4</span>, <span class="dv">4</span>))</a>
<a class="sourceLine" id="cb6-7" data-line-number="7"></a>
<a class="sourceLine" id="cb6-8" data-line-number="8">censored_plot =<span class="st"> </span>cens_df <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb6-9" data-line-number="9"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">y =</span> <span class="st">""</span>, <span class="dt">x =</span> (y_lower <span class="op">+</span><span class="st"> </span>y_upper)<span class="op">/</span><span class="dv">2</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb6-10" data-line-number="10"><span class="st">  </span><span class="kw">geom_dotplot</span>(</a>
<a class="sourceLine" id="cb6-11" data-line-number="11">    <span class="kw">aes</span>(<span class="dt">fill =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/factor">ordered</a></span>(y_lower)),</a>
<a class="sourceLine" id="cb6-12" data-line-number="12">    <span class="dt">method =</span> <span class="st">"histodot"</span>, <span class="dt">origin =</span> <span class="dv">-4</span>, <span class="dt">binwidth =</span> <span class="dv">1</span>, <span class="dt">dotsize =</span> <span class="fl">0.5</span>, <span class="dt">stackratio =</span> <span class="fl">.8</span>, <span class="dt">show.legend =</span> <span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb6-13" data-line-number="13">    <span class="dt">stackgroups =</span> <span class="ot">TRUE</span>, <span class="dt">binpositions =</span> <span class="st">"all"</span>, <span class="dt">color =</span> <span class="ot">NA</span></a>
<a class="sourceLine" id="cb6-14" data-line-number="14">  ) <span class="op">+</span></a>
<a class="sourceLine" id="cb6-15" data-line-number="15"><span class="st">  </span><span class="kw">geom_segment</span>(</a>
<a class="sourceLine" id="cb6-16" data-line-number="16">    <span class="kw">aes</span>(<span class="dt">x =</span> y <span class="op">+</span><span class="st"> </span><span class="fl">0.5</span>, <span class="dt">xend =</span> y <span class="op">+</span><span class="st"> </span><span class="fl">0.5</span>, <span class="dt">y =</span> <span class="fl">1.75</span>, <span class="dt">yend =</span> <span class="fl">1.5</span>, <span class="dt">color =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/factor">ordered</a></span>(y)),</a>
<a class="sourceLine" id="cb6-17" data-line-number="17">    <span class="dt">data =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(<span class="dt">y =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/unique">unique</a></span>(cens_df<span class="op">$</span>y_lower)), <span class="dt">show.legend =</span> <span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb6-18" data-line-number="18">    <span class="dt">arrow =</span> <span class="kw">arrow</span>(<span class="dt">type =</span> <span class="st">"closed"</span>, <span class="dt">length =</span> <span class="kw">unit</span>(<span class="dv">7</span>, <span class="st">"points"</span>)), <span class="dt">size =</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb6-19" data-line-number="19">  ) <span class="op">+</span></a>
<a class="sourceLine" id="cb6-20" data-line-number="20"><span class="st">  </span><span class="kw">ylab</span>(<span class="ot">NULL</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb6-21" data-line-number="21"><span class="st">  </span><span class="kw">xlab</span>(<span class="st">"interval-censored y"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb6-22" data-line-number="22"><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="dt">breaks =</span> <span class="dv">-4</span><span class="op">:</span><span class="dv">4</span>, <span class="dt">limits =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="op">-</span><span class="dv">4</span>, <span class="dv">4</span>))</a>
<a class="sourceLine" id="cb6-23" data-line-number="23"></a>
<a class="sourceLine" id="cb6-24" data-line-number="24"><span class="kw">plot_grid</span>(<span class="dt">align =</span> <span class="st">"v"</span>, <span class="dt">ncol =</span> <span class="dv">1</span>, <span class="dt">rel_heights =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">1</span>, <span class="fl">2.5</span>),</a>
<a class="sourceLine" id="cb6-25" data-line-number="25">  uncensored_plot,</a>
<a class="sourceLine" id="cb6-26" data-line-number="26">  censored_plot</a>
<a class="sourceLine" id="cb6-27" data-line-number="27">)</a></code></pre></div>
<p><img src="tidybayes-residuals_files/figure-html/unnamed-chunk-4-1.png" width="168"></p>
</div>
<div id="model-for-y_star" class="section level2">
<h2 class="hasAnchor">
<a href="#model-for-y_star" class="anchor"></a>Model for <code>y_star</code>
</h2>
<p>Before we fit a model to the censored data, let’s see what an ideal model looks like: we’ll fit a model to <code>y_star</code>. With censored or discrete data in the real-world, we would not be able to fit such a model, because we would not have observations of <code>y_star</code>, only the intervals. But this might help us understand what we’re looking for in a fit that’s working.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1">m_ideal =<span class="st"> </span><span class="kw">brm</span>(y_star <span class="op">~</span><span class="st"> </span><span class="dv">1</span>, <span class="dt">data =</span> cens_df, <span class="dt">family =</span> student)</a></code></pre></div>
<pre><code>## Compiling the C++ model</code></pre>
<pre><code>## Start sampling</code></pre>
<p>This looks like this:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1">m_ideal</a></code></pre></div>
<pre><code>##  Family: student 
##   Links: mu = identity; sigma = identity; nu = identity 
## Formula: y_star ~ 1 
##    Data: cens_df (Number of observations: 100) 
## Samples: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
##          total post-warmup samples = 4000
## 
## Population-Level Effects: 
##           Estimate Est.Error l-95% CI u-95% CI Eff.Sample Rhat
## Intercept     0.52      0.11     0.31     0.74       2710 1.00
## 
## Family Specific Parameters: 
##       Estimate Est.Error l-95% CI u-95% CI Eff.Sample Rhat
## sigma     1.02      0.09     0.85     1.20       2363 1.00
## nu       21.03     13.53     5.03    54.17       2725 1.00
## 
## Samples were drawn using sampling(NUTS). For each parameter, Eff.Sample 
## is a crude measure of effective sample size, and Rhat is the potential 
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<div id="residuals" class="section level3">
<h3 class="hasAnchor">
<a href="#residuals" class="anchor"></a>Residuals</h3>
<p><code><a href="../reference/add_predicted_draws.html">add_residual_draws()</a></code> operates much like <code><a href="../reference/add_predicted_draws.html">add_fitted_draws()</a></code> and <code><a href="../reference/add_predicted_draws.html">add_predicted_draws()</a></code>: it gives us draws from the posterior distribution for each residual:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1">cens_df <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb12-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="../reference/add_predicted_draws.html">add_residual_draws</a></span>(m_ideal) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb12-3" data-line-number="3"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> .row, <span class="dt">y =</span> .residual)) <span class="op">+</span></a>
<a class="sourceLine" id="cb12-4" data-line-number="4"><span class="st">  </span><span class="kw"><a href="../reference/stat_pointinterval.html">stat_pointinterval</a></span>()</a></code></pre></div>
<p><img src="tidybayes-residuals_files/figure-html/unnamed-chunk-7-1.png" width="576"></p>
<p>This is a typical residual plot, though with the addition of the uncertainty associated with each residual afforded by generating draws from the distribution associated with each residual.</p>
<p>Let’s check the QQ plot:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1">cens_df <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb13-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="../reference/add_predicted_draws.html">add_residual_draws</a></span>(m_ideal) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb13-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="../reference/point_interval.html">median_qi</a></span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb13-4" data-line-number="4"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">sample =</span> .residual)) <span class="op">+</span></a>
<a class="sourceLine" id="cb13-5" data-line-number="5"><span class="st">  </span><span class="kw">geom_qq</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb13-6" data-line-number="6"><span class="st">  </span><span class="kw">geom_qq_line</span>()</a></code></pre></div>
<p><img src="tidybayes-residuals_files/figure-html/unnamed-chunk-8-1.png" width="576"></p>
<p>This is a typical way of looking at residuals. However, this type of residual will not generalize to discrete and censored models, so let’s consider something else…</p>
</div>
<div id="probability-residuals-and-quantile-residuals" class="section level3">
<h3 class="hasAnchor">
<a href="#probability-residuals-and-quantile-residuals" class="anchor"></a>Probability residuals and quantile residuals</h3>
<p>We can use the posterior predictive probability <span class="math inline">\(P(y^*_\textrm{rep} &lt; y^*|\theta)\)</span> as a sort of <strong>probability residual</strong> (<code>p_residual</code> below). If the predictive distribution is well-calibrated, these probabilities should be uniform, and if we apply the inverse cumulative distribution function (CDF) of the standard Normal distribution to these probability residuals, the result should be standard Normal. These are <strong>quantile residuals</strong> (<code>q_residual</code>).</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1">cens_df <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="../reference/add_predicted_draws.html">add_predicted_draws</a></span>(m_ideal) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-3" data-line-number="3"><span class="st">  </span><span class="kw">summarise</span>(</a>
<a class="sourceLine" id="cb14-4" data-line-number="4">    <span class="dt">p_residual =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(.prediction <span class="op">&lt;</span><span class="st"> </span>y_star),</a>
<a class="sourceLine" id="cb14-5" data-line-number="5">    <span class="dt">q_residual =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">qnorm</a></span>(p_residual)</a>
<a class="sourceLine" id="cb14-6" data-line-number="6">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-7" data-line-number="7"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">sample =</span> q_residual)) <span class="op">+</span></a>
<a class="sourceLine" id="cb14-8" data-line-number="8"><span class="st">  </span><span class="kw">geom_qq</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb14-9" data-line-number="9"><span class="st">  </span><span class="kw">geom_abline</span>()</a></code></pre></div>
<p><img src="tidybayes-residuals_files/figure-html/unnamed-chunk-9-1.png" width="576"></p>
<p>This QQ plot shows us the model fits pretty well.</p>
</div>
</div>
<div id="basic-interval-censored-model" class="section level2">
<h2 class="hasAnchor">
<a href="#basic-interval-censored-model" class="anchor"></a>Basic interval-censored model</h2>
<p>Assuming a situation where we do not have access to the original (uncensored) data, we will perform a regression on the interval-censored data. In brms, we can do this by specifying the lower (<code>y_lower</code>) and upper (<code>y_upper</code>) bounds on each observation, and the censoring type (<code>censoring</code>), which in this case is <code>"interval"</code> for all observations.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1">m =<span class="st"> </span><span class="kw">brm</span>(y_lower <span class="op">|</span><span class="st"> </span><span class="kw">cens</span>(censoring, y_upper) <span class="op">~</span><span class="st"> </span><span class="dv">1</span>, <span class="dt">data =</span> cens_df)</a></code></pre></div>
<pre><code>## Compiling the C++ model</code></pre>
<pre><code>## Start sampling</code></pre>
<p>The results look like this:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" data-line-number="1">m</a></code></pre></div>
<pre><code>##  Family: gaussian 
##   Links: mu = identity; sigma = identity 
## Formula: y_lower | cens(censoring, y_upper) ~ 1 
##    Data: cens_df (Number of observations: 100) 
## Samples: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
##          total post-warmup samples = 4000
## 
## Population-Level Effects: 
##           Estimate Est.Error l-95% CI u-95% CI Eff.Sample Rhat
## Intercept     0.56      0.11     0.33     0.77       2476 1.00
## 
## Family Specific Parameters: 
##       Estimate Est.Error l-95% CI u-95% CI Eff.Sample Rhat
## sigma     1.09      0.08     0.94     1.27       2568 1.00
## 
## Samples were drawn using sampling(NUTS). For each parameter, Eff.Sample 
## is a crude measure of effective sample size, and Rhat is the potential 
## scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<p>Again, <code><a href="../reference/add_predicted_draws.html">add_residual_draws()</a></code> lets us look at the residuals:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" data-line-number="1">cens_df <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb20-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="../reference/add_predicted_draws.html">add_residual_draws</a></span>(m) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb20-3" data-line-number="3"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> .row, <span class="dt">y =</span> .residual)) <span class="op">+</span></a>
<a class="sourceLine" id="cb20-4" data-line-number="4"><span class="st">  </span><span class="kw"><a href="../reference/stat_pointinterval.html">stat_pointinterval</a></span>()</a></code></pre></div>
<pre><code>## Warning: Results may not be meaningful for censored models.</code></pre>
<p><img src="tidybayes-residuals_files/figure-html/unnamed-chunk-12-1.png" width="576"></p>
<p>But notice the horizontal striations due to censoring. This obscures patterns we might wish to see in the diagnostic plots. Patterns like this often show up in censored regression, logistic regression, Poisson regression, and other discrete regression models. Notice how <code>brms</code> also gives us a warning message that the residuals may not be meaningful due to censoring.</p>
<p>Let’s look at the QQ plot:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" data-line-number="1">cens_df <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb22-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="../reference/add_predicted_draws.html">add_residual_draws</a></span>(m) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb22-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="../reference/point_interval.html">median_qi</a></span>(.residual) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb22-4" data-line-number="4"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">sample =</span> .residual)) <span class="op">+</span></a>
<a class="sourceLine" id="cb22-5" data-line-number="5"><span class="st">  </span><span class="kw">geom_qq</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb22-6" data-line-number="6"><span class="st">  </span><span class="kw">geom_qq_line</span>()</a></code></pre></div>
<pre><code>## Warning: Results may not be meaningful for censored models.</code></pre>
<p><img src="tidybayes-residuals_files/figure-html/unnamed-chunk-13-1.png" width="576"></p>
<p>Again, the striations are making interpretation difficult. But there is hope!</p>
<div id="randomized-quantile-residuals" class="section level3">
<h3 class="hasAnchor">
<a href="#randomized-quantile-residuals" class="anchor"></a>Randomized quantile residuals</h3>
<p>We can extend the ideas of <strong>probability residuals</strong> to make <strong>randomized probability residuals</strong>.</p>
<p>Where the probability residual for the uncensored model was something like this:</p>
<p><span class="math display">\[
r^*_\textrm{prob} = P(y^*_\textrm{rep} &lt; y^*|\theta)
\]</span> We can’t calculate the residual for a censored observation this way, as we do not know what <span class="math inline">\(y^*\)</span> is. However, we do know that <span class="math inline">\(r^*_\textrm{prob}\)</span> should be in the following interval:</p>
<p><span class="math display">\[
\begin{align*}
&amp;&amp; r^*_\textrm{prob} &amp;\in (r_\textrm{lower}, r_\textrm{upper}] \\
&amp;where&amp; r_\textrm{lower} &amp;= P(y^*_\textrm{rep} &lt; y_\textrm{lower}|\theta) \\
&amp;&amp;      r_\textrm{upper} &amp;= P(y^*_\textrm{rep} &lt; y_\textrm{upper}|\theta)
\end{align*}
\]</span></p>
<p>If we define a <strong>randomized probability residual</strong> as:</p>
<p><span class="math display">\[
r_\textrm{prob} \sim \textrm{Uniform}(r_\textrm{lower}, r_\textrm{upper})
\]</span></p>
<p>Then these residuals will be unformly random (see <a href="http://doi.org/10.2307/1390802">Dunn and Smyth 1996</a>), and we can similarly define a <strong>randomized quantile residual</strong> by passing the probability residuals through the Normal inverse CDF. Like so:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" data-line-number="1">cens_df <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb24-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="../reference/add_predicted_draws.html">add_predicted_draws</a></span>(m) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb24-3" data-line-number="3"><span class="st">  </span><span class="kw">summarise</span>(</a>
<a class="sourceLine" id="cb24-4" data-line-number="4">    <span class="dt">p_lower =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(.prediction <span class="op">&lt;</span><span class="st"> </span>y_lower),</a>
<a class="sourceLine" id="cb24-5" data-line-number="5">    <span class="dt">p_upper =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(.prediction <span class="op">&lt;</span><span class="st"> </span>y_upper),</a>
<a class="sourceLine" id="cb24-6" data-line-number="6">    <span class="dt">p_residual =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Uniform">runif</a></span>(<span class="dv">1</span>, p_lower, p_upper),</a>
<a class="sourceLine" id="cb24-7" data-line-number="7">    <span class="dt">q_residual =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">qnorm</a></span>(p_residual)</a>
<a class="sourceLine" id="cb24-8" data-line-number="8">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb24-9" data-line-number="9"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> .row, <span class="dt">y =</span> q_residual)) <span class="op">+</span></a>
<a class="sourceLine" id="cb24-10" data-line-number="10"><span class="st">  </span><span class="kw">geom_point</span>()</a></code></pre></div>
<p><img src="tidybayes-residuals_files/figure-html/unnamed-chunk-14-1.png" width="576"></p>
<p>The striations are gone! And a QQ plot:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" data-line-number="1">cens_df <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb25-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="../reference/add_predicted_draws.html">add_predicted_draws</a></span>(m) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb25-3" data-line-number="3"><span class="st">  </span><span class="kw">summarise</span>(</a>
<a class="sourceLine" id="cb25-4" data-line-number="4">    <span class="dt">p_lower =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(.prediction <span class="op">&lt;</span><span class="st"> </span>y_lower),</a>
<a class="sourceLine" id="cb25-5" data-line-number="5">    <span class="dt">p_upper =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(.prediction <span class="op">&lt;</span><span class="st"> </span>y_upper),</a>
<a class="sourceLine" id="cb25-6" data-line-number="6">    <span class="dt">p_residual =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Uniform">runif</a></span>(<span class="dv">1</span>, p_lower, p_upper),</a>
<a class="sourceLine" id="cb25-7" data-line-number="7">    <span class="dt">q_residual =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">qnorm</a></span>(p_residual)</a>
<a class="sourceLine" id="cb25-8" data-line-number="8">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb25-9" data-line-number="9"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">sample =</span> q_residual)) <span class="op">+</span></a>
<a class="sourceLine" id="cb25-10" data-line-number="10"><span class="st">  </span><span class="kw">geom_qq</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb25-11" data-line-number="11"><span class="st">  </span><span class="kw">geom_abline</span>()</a></code></pre></div>
<p><img src="tidybayes-residuals_files/figure-html/unnamed-chunk-15-1.png" width="576"></p>
<p>Looks decent. However, our residuals are now subject to noise—we actually have a distribution of possible QQ plots. So, let’s check on some of them to make sure this nice-looking one is not just a fluke. We’ll employ <a href="https://mucollective.co/project/hops-trends">HOPs</a> to do that:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb26-1" data-line-number="1">k =<span class="st"> </span><span class="dv">50</span></a>
<a class="sourceLine" id="cb26-2" data-line-number="2"></a>
<a class="sourceLine" id="cb26-3" data-line-number="3">p =<span class="st"> </span>cens_df <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb26-4" data-line-number="4"><span class="st">  </span><span class="kw"><a href="../reference/add_predicted_draws.html">add_predicted_draws</a></span>(m) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb26-5" data-line-number="5"><span class="st">  </span><span class="kw">summarise</span>(</a>
<a class="sourceLine" id="cb26-6" data-line-number="6">    <span class="dt">p_lower =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(.prediction <span class="op">&lt;</span><span class="st"> </span>y_lower),</a>
<a class="sourceLine" id="cb26-7" data-line-number="7">    <span class="dt">p_upper =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(.prediction <span class="op">&lt;</span><span class="st"> </span>y_upper),</a>
<a class="sourceLine" id="cb26-8" data-line-number="8">    <span class="dt">p_residual =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Uniform">runif</a></span>(k, p_lower, p_upper)),</a>
<a class="sourceLine" id="cb26-9" data-line-number="9">    <span class="dt">residual_draw =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dv">1</span><span class="op">:</span>k)</a>
<a class="sourceLine" id="cb26-10" data-line-number="10">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb26-11" data-line-number="11"><span class="st">  </span><span class="kw">unnest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb26-12" data-line-number="12"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">q_residual =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">qnorm</a></span>(p_residual)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb26-13" data-line-number="13"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">sample =</span> q_residual)) <span class="op">+</span></a>
<a class="sourceLine" id="cb26-14" data-line-number="14"><span class="st">  </span><span class="kw">geom_qq</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb26-15" data-line-number="15"><span class="st">  </span><span class="kw">geom_abline</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb26-16" data-line-number="16"><span class="st">  </span><span class="kw">transition_manual</span>(residual_draw)</a>
<a class="sourceLine" id="cb26-17" data-line-number="17"></a>
<a class="sourceLine" id="cb26-18" data-line-number="18"><span class="kw">animate</span>(p, <span class="dt">width =</span> <span class="dv">1152</span>, <span class="dt">height =</span> <span class="dv">768</span>, <span class="dt">res =</span> <span class="dv">192</span>, <span class="dt">type =</span> <span class="st">"cairo"</span>)</a></code></pre></div>
<pre><code>## nframes and fps adjusted to match transition</code></pre>
<p><img src="tidybayes-residuals_files/figure-html/unnamed-chunk-16-1.gif"><!-- --></p>
<p>Looks good.</p>
</div>
</div>
<div id="what-if-the-model-does-not-fit-well" class="section level2">
<h2 class="hasAnchor">
<a href="#what-if-the-model-does-not-fit-well" class="anchor"></a>What if the model does not fit well?</h2>
<p>Let’s instead generate the data from a t distribution, which should give us some more extreme values:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb28-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Random">set.seed</a></span>(<span class="dv">41181</span>)</a>
<a class="sourceLine" id="cb28-2" data-line-number="2">n =<span class="st"> </span><span class="dv">100</span></a>
<a class="sourceLine" id="cb28-3" data-line-number="3"></a>
<a class="sourceLine" id="cb28-4" data-line-number="4">cens_df_t =</a>
<a class="sourceLine" id="cb28-5" data-line-number="5"><span class="st">  </span><span class="kw">data_frame</span>(</a>
<a class="sourceLine" id="cb28-6" data-line-number="6">    <span class="dt">y =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/TDist">rt</a></span>(n, <span class="dv">3</span>) <span class="op">+</span><span class="st"> </span><span class="fl">0.5</span>,</a>
<a class="sourceLine" id="cb28-7" data-line-number="7">    <span class="dt">y_lower =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Round">floor</a></span>(y),</a>
<a class="sourceLine" id="cb28-8" data-line-number="8">    <span class="dt">y_upper =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Round">ceiling</a></span>(y),</a>
<a class="sourceLine" id="cb28-9" data-line-number="9">    <span class="dt">censoring =</span> <span class="st">"interval"</span></a>
<a class="sourceLine" id="cb28-10" data-line-number="10">  )</a></code></pre></div>
<p>Note the presence of outliers:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb29-1" data-line-number="1">uncensored_plot =<span class="st"> </span>cens_df_t <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb29-2" data-line-number="2"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">y =</span> <span class="st">""</span>, <span class="dt">x =</span> y)) <span class="op">+</span></a>
<a class="sourceLine" id="cb29-3" data-line-number="3"><span class="st">  </span><span class="kw">geom_density_ridges</span>(<span class="dt">bandwidth =</span> <span class="fl">0.5</span>, <span class="dt">scale =</span> <span class="fl">1.5</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb29-4" data-line-number="4"><span class="st">  </span><span class="kw">geom_jitter</span>(<span class="kw">aes</span>(<span class="dt">y =</span> <span class="fl">0.75</span>, <span class="dt">color =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/factor">ordered</a></span>(y_lower)), <span class="dt">position =</span> <span class="kw">position_jitter</span>(<span class="dt">height =</span> <span class="fl">0.2</span>), <span class="dt">show.legend =</span> <span class="ot">FALSE</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb29-5" data-line-number="5"><span class="st">  </span><span class="kw">ylab</span>(<span class="ot">NULL</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb29-6" data-line-number="6"><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="dt">breaks =</span> <span class="dv">-10</span><span class="op">:</span><span class="dv">10</span>, <span class="dt">limits =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="op">-</span><span class="dv">10</span>, <span class="dv">10</span>))</a>
<a class="sourceLine" id="cb29-7" data-line-number="7"></a>
<a class="sourceLine" id="cb29-8" data-line-number="8">censored_plot =<span class="st"> </span>cens_df_t <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb29-9" data-line-number="9"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">y =</span> <span class="st">""</span>, <span class="dt">x =</span> (y_lower <span class="op">+</span><span class="st"> </span>y_upper)<span class="op">/</span><span class="dv">2</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb29-10" data-line-number="10"><span class="st">  </span><span class="kw">geom_dotplot</span>(</a>
<a class="sourceLine" id="cb29-11" data-line-number="11">    <span class="kw">aes</span>(<span class="dt">fill =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/factor">ordered</a></span>(y_lower)),</a>
<a class="sourceLine" id="cb29-12" data-line-number="12">    <span class="dt">method =</span> <span class="st">"histodot"</span>, <span class="dt">origin =</span> <span class="dv">-4</span>, <span class="dt">binwidth =</span> <span class="dv">1</span>, <span class="dt">dotsize =</span> <span class="fl">0.5</span>, <span class="dt">stackratio =</span> <span class="fl">.8</span>, <span class="dt">show.legend =</span> <span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb29-13" data-line-number="13">    <span class="dt">stackgroups =</span> <span class="ot">TRUE</span>, <span class="dt">binpositions =</span> <span class="st">"all"</span>, <span class="dt">color =</span> <span class="ot">NA</span></a>
<a class="sourceLine" id="cb29-14" data-line-number="14">  ) <span class="op">+</span></a>
<a class="sourceLine" id="cb29-15" data-line-number="15"><span class="st">  </span><span class="kw">geom_segment</span>(</a>
<a class="sourceLine" id="cb29-16" data-line-number="16">    <span class="kw">aes</span>(<span class="dt">x =</span> y <span class="op">+</span><span class="st"> </span><span class="fl">0.5</span>, <span class="dt">xend =</span> y <span class="op">+</span><span class="st"> </span><span class="fl">0.5</span>, <span class="dt">y =</span> <span class="fl">1.75</span>, <span class="dt">yend =</span> <span class="fl">1.5</span>, <span class="dt">color =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/factor">ordered</a></span>(y)),</a>
<a class="sourceLine" id="cb29-17" data-line-number="17">    <span class="dt">data =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(<span class="dt">y =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/unique">unique</a></span>(cens_df_t<span class="op">$</span>y_lower)), <span class="dt">show.legend =</span> <span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb29-18" data-line-number="18">    <span class="dt">arrow =</span> <span class="kw">arrow</span>(<span class="dt">type =</span> <span class="st">"closed"</span>, <span class="dt">length =</span> <span class="kw">unit</span>(<span class="dv">7</span>, <span class="st">"points"</span>)), <span class="dt">size =</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb29-19" data-line-number="19">  ) <span class="op">+</span></a>
<a class="sourceLine" id="cb29-20" data-line-number="20"><span class="st">  </span><span class="kw">ylab</span>(<span class="ot">NULL</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb29-21" data-line-number="21"><span class="st">  </span><span class="kw">xlab</span>(<span class="st">"interval-censored y"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb29-22" data-line-number="22"><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="dt">breaks =</span> <span class="dv">-10</span><span class="op">:</span><span class="dv">10</span>, <span class="dt">limits =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="op">-</span><span class="dv">10</span>, <span class="dv">10</span>))</a>
<a class="sourceLine" id="cb29-23" data-line-number="23"></a>
<a class="sourceLine" id="cb29-24" data-line-number="24"><span class="kw">plot_grid</span>(<span class="dt">align =</span> <span class="st">"v"</span>, <span class="dt">ncol =</span> <span class="dv">1</span>, <span class="dt">rel_heights =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">1</span>, <span class="fl">2.25</span>),</a>
<a class="sourceLine" id="cb29-25" data-line-number="25">  uncensored_plot,</a>
<a class="sourceLine" id="cb29-26" data-line-number="26">  censored_plot</a>
<a class="sourceLine" id="cb29-27" data-line-number="27">)</a></code></pre></div>
<p><img src="tidybayes-residuals_files/figure-html/unnamed-chunk-18-1.png" width="384"></p>
<div id="model" class="section level3">
<h3 class="hasAnchor">
<a href="#model" class="anchor"></a>Model</h3>
<p>Now, fitting the same model as before:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb30-1" data-line-number="1">m_t1 =<span class="st"> </span><span class="kw">brm</span>(y_lower <span class="op">|</span><span class="st"> </span><span class="kw">cens</span>(censoring, y_upper) <span class="op">~</span><span class="st"> </span><span class="dv">1</span>, <span class="dt">data =</span> cens_df_t)</a></code></pre></div>
<pre><code>## Compiling the C++ model</code></pre>
<pre><code>## recompiling to avoid crashing R session</code></pre>
<pre><code>## Start sampling</code></pre>
<p>And checking the QQ plot:</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb34-1" data-line-number="1">cens_df_t <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb34-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="../reference/add_predicted_draws.html">add_residual_draws</a></span>(m_t1) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb34-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="../reference/point_interval.html">median_qi</a></span>(.residual) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb34-4" data-line-number="4"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">sample =</span> .residual)) <span class="op">+</span></a>
<a class="sourceLine" id="cb34-5" data-line-number="5"><span class="st">  </span><span class="kw">geom_qq</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb34-6" data-line-number="6"><span class="st">  </span><span class="kw">geom_qq_line</span>()</a></code></pre></div>
<pre><code>## Warning: Results may not be meaningful for censored models.</code></pre>
<p><img src="tidybayes-residuals_files/figure-html/unnamed-chunk-20-1.png" width="576"></p>
<p>It looks like this could be problematic, but the striations make diagnosing the problem difficult.</p>
</div>
<div id="randomized-quantile-residuals-1" class="section level3">
<h3 class="hasAnchor">
<a href="#randomized-quantile-residuals-1" class="anchor"></a>Randomized quantile residuals</h3>
<p>Let’s try randomized quantile residuals again:</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb36-1" data-line-number="1">cens_df_t <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb36-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="../reference/add_predicted_draws.html">add_predicted_draws</a></span>(m_t1) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb36-3" data-line-number="3"><span class="st">  </span><span class="kw">summarise</span>(</a>
<a class="sourceLine" id="cb36-4" data-line-number="4">    <span class="dt">p_lower =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(.prediction <span class="op">&lt;</span><span class="st"> </span>y_lower),</a>
<a class="sourceLine" id="cb36-5" data-line-number="5">    <span class="dt">p_upper =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(.prediction <span class="op">&lt;</span><span class="st"> </span>y_upper),</a>
<a class="sourceLine" id="cb36-6" data-line-number="6">    <span class="dt">p_residual =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Uniform">runif</a></span>(<span class="dv">1</span>, p_lower, p_upper),</a>
<a class="sourceLine" id="cb36-7" data-line-number="7">    <span class="dt">q_residual =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">qnorm</a></span>(p_residual)</a>
<a class="sourceLine" id="cb36-8" data-line-number="8">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb36-9" data-line-number="9"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">sample =</span> q_residual)) <span class="op">+</span></a>
<a class="sourceLine" id="cb36-10" data-line-number="10"><span class="st">  </span><span class="kw">geom_qq</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb36-11" data-line-number="11"><span class="st">  </span><span class="kw">geom_abline</span>()</a></code></pre></div>
<pre><code>## Warning: Removed 1 rows containing non-finite values (stat_qq).</code></pre>
<p><img src="tidybayes-residuals_files/figure-html/unnamed-chunk-21-1.png" width="576"></p>
<p>Does not look good for the model—this s-shape is characteristic of excess kurtosis (aka fat tails), which is exactly what a t distribution should produce. But let’s check using HOPs again:</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb38-1" data-line-number="1">k =<span class="st"> </span><span class="dv">50</span></a>
<a class="sourceLine" id="cb38-2" data-line-number="2"></a>
<a class="sourceLine" id="cb38-3" data-line-number="3">p =<span class="st"> </span>cens_df_t <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb38-4" data-line-number="4"><span class="st">  </span><span class="kw"><a href="../reference/add_predicted_draws.html">add_predicted_draws</a></span>(m_t1) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb38-5" data-line-number="5"><span class="st">  </span><span class="kw">summarise</span>(</a>
<a class="sourceLine" id="cb38-6" data-line-number="6">    <span class="dt">p_lower =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(.prediction <span class="op">&lt;</span><span class="st"> </span>y_lower),</a>
<a class="sourceLine" id="cb38-7" data-line-number="7">    <span class="dt">p_upper =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(.prediction <span class="op">&lt;</span><span class="st"> </span>y_upper),</a>
<a class="sourceLine" id="cb38-8" data-line-number="8">    <span class="dt">p_residual =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Uniform">runif</a></span>(k, p_lower, p_upper)),</a>
<a class="sourceLine" id="cb38-9" data-line-number="9">    <span class="dt">residual_draw =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dv">1</span><span class="op">:</span>k)</a>
<a class="sourceLine" id="cb38-10" data-line-number="10">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb38-11" data-line-number="11"><span class="st">  </span><span class="kw">unnest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb38-12" data-line-number="12"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">q_residual =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">qnorm</a></span>(p_residual)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb38-13" data-line-number="13"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">sample =</span> q_residual)) <span class="op">+</span></a>
<a class="sourceLine" id="cb38-14" data-line-number="14"><span class="st">  </span><span class="kw">geom_qq</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb38-15" data-line-number="15"><span class="st">  </span><span class="kw">geom_abline</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb38-16" data-line-number="16"><span class="st">  </span><span class="kw">transition_manual</span>(residual_draw)</a>
<a class="sourceLine" id="cb38-17" data-line-number="17"></a>
<a class="sourceLine" id="cb38-18" data-line-number="18"><span class="kw">animate</span>(p, <span class="dt">width =</span> <span class="dv">1152</span>, <span class="dt">height =</span> <span class="dv">768</span>, <span class="dt">res =</span> <span class="dv">192</span>, <span class="dt">type =</span> <span class="st">"cairo"</span>)</a></code></pre></div>
<pre><code>## Warning: Removed 50 rows containing non-finite values (stat_qq).</code></pre>
<pre><code>## nframes and fps adjusted to match transition</code></pre>
<p><img src="tidybayes-residuals_files/figure-html/unnamed-chunk-22-1.gif"><!-- --></p>
<p>Still not good! But the clear s shape is very diagnostic of fat tails, so let’s try a different model.</p>
</div>
</div>
<div id="robust-interval-censored-model" class="section level2">
<h2 class="hasAnchor">
<a href="#robust-interval-censored-model" class="anchor"></a>Robust interval-censored model</h2>
<p>A common model to try to “robustify” linear regression is to swap out the Normal response distribution for a Student’s t distribution, which has fatter tails (it also happens that this is the distribution used to generate the data above, so I am clearly cheating, but also: <em>this had better work</em>).</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb41-1" data-line-number="1">m_t2 =<span class="st"> </span><span class="kw">brm</span>(y_lower <span class="op">|</span><span class="st"> </span><span class="kw">cens</span>(censoring, y_upper) <span class="op">~</span><span class="st"> </span><span class="dv">1</span>, <span class="dt">data =</span> cens_df_t, <span class="dt">family =</span> student)</a></code></pre></div>
<pre><code>## Compiling the C++ model</code></pre>
<pre><code>## Start sampling</code></pre>
<p>Let’s look at the QQ plot of the residuals:</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb44-1" data-line-number="1">cens_df_t <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb44-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="../reference/add_predicted_draws.html">add_residual_draws</a></span>(m_t2) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb44-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="../reference/point_interval.html">median_qi</a></span>(.residual) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb44-4" data-line-number="4"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">sample =</span> .residual)) <span class="op">+</span></a>
<a class="sourceLine" id="cb44-5" data-line-number="5"><span class="st">  </span><span class="kw">geom_qq</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb44-6" data-line-number="6"><span class="st">  </span><span class="kw">geom_qq_line</span>()</a></code></pre></div>
<pre><code>## Warning: Results may not be meaningful for censored models.</code></pre>
<p><img src="tidybayes-residuals_files/figure-html/unnamed-chunk-24-1.png" width="576"></p>
<p>Odd, these don’t look great! But again, these residuals are not to be trusted…</p>
<div id="randomized-quantile-residuals-2" class="section level3">
<h3 class="hasAnchor">
<a href="#randomized-quantile-residuals-2" class="anchor"></a>Randomized quantile residuals</h3>
<p>Let’s check out the randomized quantile residuals:</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb46-1" data-line-number="1">k =<span class="st"> </span><span class="dv">50</span></a>
<a class="sourceLine" id="cb46-2" data-line-number="2"></a>
<a class="sourceLine" id="cb46-3" data-line-number="3">p =<span class="st"> </span>cens_df_t <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb46-4" data-line-number="4"><span class="st">  </span><span class="kw"><a href="../reference/add_predicted_draws.html">add_predicted_draws</a></span>(m_t2) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb46-5" data-line-number="5"><span class="st">  </span><span class="kw">summarise</span>(</a>
<a class="sourceLine" id="cb46-6" data-line-number="6">    <span class="dt">p_lower =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(.prediction <span class="op">&lt;</span><span class="st"> </span>y_lower),</a>
<a class="sourceLine" id="cb46-7" data-line-number="7">    <span class="dt">p_upper =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(.prediction <span class="op">&lt;</span><span class="st"> </span>y_upper),</a>
<a class="sourceLine" id="cb46-8" data-line-number="8">    <span class="dt">p_residual =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Uniform">runif</a></span>(k, p_lower, p_upper)),</a>
<a class="sourceLine" id="cb46-9" data-line-number="9">    <span class="dt">residual_draw =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dv">1</span><span class="op">:</span>k)</a>
<a class="sourceLine" id="cb46-10" data-line-number="10">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb46-11" data-line-number="11"><span class="st">  </span><span class="kw">unnest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb46-12" data-line-number="12"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">q_residual =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">qnorm</a></span>(p_residual)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb46-13" data-line-number="13"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">sample =</span> q_residual)) <span class="op">+</span></a>
<a class="sourceLine" id="cb46-14" data-line-number="14"><span class="st">  </span><span class="kw">geom_qq</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb46-15" data-line-number="15"><span class="st">  </span><span class="kw">geom_abline</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb46-16" data-line-number="16"><span class="st">  </span><span class="kw">transition_manual</span>(residual_draw)</a>
<a class="sourceLine" id="cb46-17" data-line-number="17"></a>
<a class="sourceLine" id="cb46-18" data-line-number="18"><span class="kw">animate</span>(p, <span class="dt">width =</span> <span class="dv">1152</span>, <span class="dt">height =</span> <span class="dv">768</span>, <span class="dt">res =</span> <span class="dv">192</span>, <span class="dt">type =</span> <span class="st">"cairo"</span>)</a></code></pre></div>
<pre><code>## nframes and fps adjusted to match transition</code></pre>
<p><img src="tidybayes-residuals_files/figure-html/unnamed-chunk-25-1.gif"><!-- --></p>
<p>Looking pretty good! As well they should, since this is the same model that generated the data.</p>
</div>
</div>
<div id="ordinal-regression" class="section level2">
<h2 class="hasAnchor">
<a href="#ordinal-regression" class="anchor"></a>Ordinal regression</h2>
<p>But we’re not done yet—another sensible choice of model for this data might have been an ordinal regression. So let’s try that too.</p>
<p>First, we’ll add a column that transforms the data into an ordered factor:</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb48-1" data-line-number="1">cens_df_o =<span class="st"> </span>cens_df_t <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb48-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">y_factor =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/factor">ordered</a></span>(y_lower))</a></code></pre></div>
<p>Then we’ll fit an ordinal regression model. We have to adjust the fit parameters a bit to get it to converge (I suspect this is because some of the categories have zero observations):</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb49-1" data-line-number="1">m_o =<span class="st"> </span><span class="kw">brm</span>(y_factor <span class="op">~</span><span class="st"> </span><span class="dv">1</span>, <span class="dt">data =</span> cens_df_o, <span class="dt">family =</span> cumulative, </a>
<a class="sourceLine" id="cb49-2" data-line-number="2">  <span class="dt">prior =</span> <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="dv">10</span>), <span class="dt">class =</span> Intercept), <span class="dt">control =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">adapt_delta =</span> <span class="fl">0.99</span>))</a></code></pre></div>
<pre><code>## Compiling the C++ model</code></pre>
<pre><code>## Start sampling</code></pre>
<p>Now, let’s check out those residuals:</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb52-1" data-line-number="1">cens_df_o <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb52-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="../reference/add_predicted_draws.html">add_residual_draws</a></span>(m_o) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb52-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="../reference/point_interval.html">median_qi</a></span>(.residual) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb52-4" data-line-number="4"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">sample =</span> .residual)) <span class="op">+</span></a>
<a class="sourceLine" id="cb52-5" data-line-number="5"><span class="st">  </span><span class="kw">geom_qq</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb52-6" data-line-number="6"><span class="st">  </span><span class="kw">geom_qq_line</span>()</a></code></pre></div>
<pre><code>## Error: Residuals are not defined for ordinal or categorical models.</code></pre>
<p>Gah! <code>brms</code> will not even produce residuals for models like these. Fortunately, we can still construct randomized quantile residuals.</p>
<div id="randomized-quantile-residuals-for-a-discrete-distribution" class="section level3">
<h3 class="hasAnchor">
<a href="#randomized-quantile-residuals-for-a-discrete-distribution" class="anchor"></a>Randomized quantile residuals for a discrete distribution</h3>
<p>For the interval-censored model, we had:</p>
<p><span class="math display">\[
\begin{align*}
&amp;&amp; r_\textrm{lower} &amp;= P(y^*_\textrm{rep} &lt; y_\textrm{lower}|\theta) \\
&amp;&amp; r_\textrm{upper} &amp;= P(y^*_\textrm{rep} &lt; y_\textrm{upper}|\theta) \\
&amp;&amp; r_\textrm{prob} &amp;\sim \textrm{Uniform}(r_\textrm{lower}, r_\textrm{upper})
\end{align*}
\]</span></p>
<p>But that was for a model with observations of the form <span class="math inline">\((y_\textrm{lower}, y_\textrm{upper}]\)</span> and which can produce a posterior predictive distribution for the latent variable <span class="math inline">\(y^*_\textrm{rep}\)</span>. Now our observations are discrete values of the form <span class="math inline">\(y_\textrm{factor}\)</span>, and our posterior predictive distribution for <span class="math inline">\(y_\textrm{rep}\)</span> is also discrete. So we have to tweak the definition a bit:</p>
<p><span class="math display">\[
\begin{align*}
&amp;&amp; r_\textrm{lower} &amp;= P(y_\textrm{rep} &lt; y_\textrm{factor}|\theta) \\
&amp;&amp; r_\textrm{upper} &amp;= P(y_\textrm{rep} \le y_\textrm{factor}|\theta) \\
&amp;&amp; r_\textrm{prob} &amp;\sim \textrm{Uniform}(r_\textrm{lower}, r_\textrm{upper})
\end{align*}
\]</span></p>
<p>Then we proceed as before:</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb54-1" data-line-number="1">cens_df_o <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb54-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="../reference/add_predicted_draws.html">add_predicted_draws</a></span>(m_o) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb54-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">.prediction =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/factor">ordered</a></span>(.prediction)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb54-4" data-line-number="4"><span class="st">  </span><span class="kw">summarise</span>(</a>
<a class="sourceLine" id="cb54-5" data-line-number="5">    <span class="dt">p_lower =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(.prediction <span class="op">&lt;</span><span class="st"> </span>y_factor),</a>
<a class="sourceLine" id="cb54-6" data-line-number="6">    <span class="dt">p_upper =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(.prediction <span class="op">&lt;=</span><span class="st"> </span>y_factor),</a>
<a class="sourceLine" id="cb54-7" data-line-number="7">    <span class="dt">p_residual =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Uniform">runif</a></span>(<span class="dv">1</span>, p_lower, p_upper),</a>
<a class="sourceLine" id="cb54-8" data-line-number="8">    <span class="dt">q_residual =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">qnorm</a></span>(p_residual)</a>
<a class="sourceLine" id="cb54-9" data-line-number="9">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb54-10" data-line-number="10"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> .row, <span class="dt">y =</span> q_residual)) <span class="op">+</span></a>
<a class="sourceLine" id="cb54-11" data-line-number="11"><span class="st">  </span><span class="kw">geom_point</span>()</a></code></pre></div>
<p><img src="tidybayes-residuals_files/figure-html/unnamed-chunk-29-1.png" width="576"></p>
<p>Or in HOPs-QQ plot form:</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb55-1" data-line-number="1">k =<span class="st"> </span><span class="dv">50</span></a>
<a class="sourceLine" id="cb55-2" data-line-number="2"></a>
<a class="sourceLine" id="cb55-3" data-line-number="3">p =<span class="st"> </span>cens_df_o <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb55-4" data-line-number="4"><span class="st">  </span><span class="kw"><a href="../reference/add_predicted_draws.html">add_predicted_draws</a></span>(m_o) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb55-5" data-line-number="5"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">.prediction =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/factor">ordered</a></span>(.prediction)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb55-6" data-line-number="6"><span class="st">  </span><span class="kw">summarise</span>(</a>
<a class="sourceLine" id="cb55-7" data-line-number="7">    <span class="dt">p_lower =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(.prediction <span class="op">&lt;</span><span class="st"> </span>y_factor),</a>
<a class="sourceLine" id="cb55-8" data-line-number="8">    <span class="dt">p_upper =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(.prediction <span class="op">&lt;=</span><span class="st"> </span>y_factor),</a>
<a class="sourceLine" id="cb55-9" data-line-number="9">    <span class="dt">p_residual =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Uniform">runif</a></span>(k, p_lower, p_upper)),</a>
<a class="sourceLine" id="cb55-10" data-line-number="10">    <span class="dt">residual_draw =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dv">1</span><span class="op">:</span>k)</a>
<a class="sourceLine" id="cb55-11" data-line-number="11">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb55-12" data-line-number="12"><span class="st">  </span><span class="kw">unnest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb55-13" data-line-number="13"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">q_residual =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">qnorm</a></span>(p_residual)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb55-14" data-line-number="14"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">sample =</span> q_residual)) <span class="op">+</span></a>
<a class="sourceLine" id="cb55-15" data-line-number="15"><span class="st">  </span><span class="kw">geom_qq</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb55-16" data-line-number="16"><span class="st">  </span><span class="kw">geom_abline</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb55-17" data-line-number="17"><span class="st">  </span><span class="kw">transition_manual</span>(residual_draw)</a>
<a class="sourceLine" id="cb55-18" data-line-number="18"></a>
<a class="sourceLine" id="cb55-19" data-line-number="19"><span class="kw">animate</span>(p, <span class="dt">width =</span> <span class="dv">1152</span>, <span class="dt">height =</span> <span class="dv">768</span>, <span class="dt">res =</span> <span class="dv">192</span>, <span class="dt">type =</span> <span class="st">"cairo"</span>)</a></code></pre></div>
<pre><code>## nframes and fps adjusted to match transition</code></pre>
<p><img src="tidybayes-residuals_files/figure-html/unnamed-chunk-30-1.gif"><!-- --></p>
<p>It is not too surprising that the ordinal regression also works here, even though it is not the data generating model. Ordinal regressions are pretty robust.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#introduction">Introduction</a></li>
      <li><a href="#setup">Setup</a></li>
      <li><a href="#example-dataset">Example dataset</a></li>
      <li><a href="#model-for-y_star">Model for <code>y_star</code></a></li>
      <li><a href="#basic-interval-censored-model">Basic interval-censored model</a></li>
      <li><a href="#what-if-the-model-does-not-fit-well">What if the model does not fit well?</a></li>
      <li><a href="#robust-interval-censored-model">Robust interval-censored model</a></li>
      <li><a href="#ordinal-regression">Ordinal regression</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by <a href="http://www.mjskay.com">Matthew Kay</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
